/**
 * @Author: vincent
 * @Description:
 * @File:  TestBlog
 * @Version: 1.0.0
 * @Date: 2021/11/9 14:54
 */

package blog_demo

import (
	"database/sql"
	"fmt"
	"log"
	"math/rand"
	"strconv"
	"testing"

	"github.com/yanyiwu/gojieba"

	"github.com/ClickHouse/clickhouse-go"
)

var blogs = []string{
	`æˆ‘çš„11.11å¿…å›¤æ¦œå•NO.1ï¼ŒçŒœçŒœçœ‹æ˜¯ä»€ä¹ˆï¼Ÿä½œä¸ºâ€œ11.11äº¬ä¸œç¾Žå¦†OLAYå“ç‰Œé€‰å“å®˜â€ï¼Œæˆ‘é¦–å…ˆæŒ‘ä¸­çš„æ˜¯ç¾Žç™½ç²¾åŽ@OLAY æŠ—ç³–å°ç™½ç“¶ï¼å®ƒæœ‰é©å‘½æ€§æŠ—ç³–æˆåˆ†é©ç³–ç´ æ­é…çƒŸé…°èƒºï¼Œä¸‰é‡æŠ—ç³–å‡é»„æ°”ï¼Œèƒ½è®©è‚Œè‚¤ç™½åˆ°å‘å…‰~ æƒ³è¦è¶ç§‹å†¬å˜ç™½å‡é»„æ°”çš„å®å®ä»¬ï¼Œåˆ«é”™è¿‡#äº¬é€‰å¤§ç‰Œ ç¾Žä¸½ä»·åˆ°#ç¦åˆ©ï¼Œåˆ°@äº¬ä¸œç¾Žå¦† æœOLAYå°±èƒ½æŠ¢æˆ‘çš„åŒæ¬¾æŠ—ç³–å°ç™½ç“¶NçŽ‰å…°æ²¹ï¼ˆOLAYï¼‰æŠ—ç³–å°ç™½ç“¶ç²¾åŽæ¶²50mlé¢éƒ¨ç²¾åŽ... ï¼Œè¶11.11ä¼˜æƒ å¤šå¤šèµ¶ç´§å›¤è´§å§ï¼`,
	`â€œå½“æ—¶é£ŽèŠ±çº·çº·åº”æ˜¯å¥½æ—¶è¾°
  ä½•æ•…è¦ç«¯åé£Žæœˆé‡Œå­¤èº«â€
å¿ƒæ— æ—éª›åº”è¯¥æ˜¯å¾ˆç”œçš„å•Šï¼ï¼
å¯æ˜¯â€œå¤ªé€‚åˆç‰ºç‰²â€ï¼Ÿï¼Ÿæ„Ÿè§‰åˆæ˜¯è™çš„ï¼Ÿ
æµ·å¸‚å’Œæ–¹è¯¸çš„æ•…äº‹åˆ°åº•æ˜¯æ€Žä¹ˆåˆç”œåˆè™ï¼Ÿ
æ¥çœ‹çœ‹@ç”µè§†å‰§æ–›ç å¤«äºº å°±çŸ¥é“å•¦ï¼ï¼ï¼`,
	`è¿‡å®‰æ£€æ‰€æœ‰ç‰©å“éƒ½æŒ‰è¦æ±‚æ”¾å¥½ï¼Œå´æ€»æ˜¯é€šä¸è¿‡ï¼Œé—®é¢˜åˆ°åº•å‡ºåœ¨å“ªé‡Œï¼Ÿç‚¹å‡»è§†é¢‘æ­æ™“ç­”æ¡ˆã€‚ `,
	`æœ‰è¿™æ ·ä¸€ç¾¤äººï¼Œçƒˆç«ä¸­é€†è¡Œï¼Œé™©å¢ƒé‡Œæ•‘æ´ï¼Œæ´ªæ°´ä¸­åšå®ˆï¼Œä»–ä»¬æœ‰ä¸€ä¸ªå…±åŒçš„åå­—â€”â€œç«ç„°è“â€ã€‚
æ²¡æœ‰ç”Ÿæ¥è‹±å‹‡ï¼Œåªæ˜¯é€‰æ‹©æ— ç•ï¼Œ119æ¶ˆé˜²å®£ä¼ æ—¥ï¼Œä¸€èµ·#ç‚¹äº®ç«ç„°è“#ï¼Œè‡´æ•¬æœ€ç¾Žé€†è¡Œè€…ã€‚ â€‹â€‹â€‹â€‹
`,
	`ã€17å²å°‘å¥³è‚ é“å¸ƒæ»¡å¯„ç”Ÿè™«ï¼åŒ»ç”Ÿæé†’ï¼šåƒé¥­åˆ«çŠ¯è¿™ä¸ªé”™ï¼ã€‘æœ€è¿‘å¹¿ä¸œ17å²çš„å¥³å­©å°é’ç»å¸¸æ„Ÿåˆ°è…¹ç—›è…¹æ³»ï¼ŒåŽ»åŒ»é™¢ä¸€æŸ¥ç«Ÿå‘çŽ°å¥¹çš„è‚ é“é‡Œå¸ƒæ»¡å¯„ç”Ÿè™«ï¼Œè¿˜æ´»è¹¦ä¹±è·³çš„ã€‚åŒ»ç”Ÿç§°ï¼šéšä¾¿ä¸€ä¸ªé•œå¤´ä¸‹éƒ½çœ‹åˆ°æœ‰äº”å…­æ¡è™«ï¼Œæœ‰çš„ç”šè‡³å’¬ä½è‚ ç²˜è†œâ€¦åŽŸæ¥è¿™é“å®¶å¸¸èœæˆäº†å¥¹æ‚£ç—…çš„å…ƒå‡¶â†“â†“åŒ»ç”Ÿæé†’ï¼Œè¿™äº›èœä¸èƒ½è¿™æ ·åƒ`,
	`æ¹–äººè¿™çƒèµ¢çš„çœŸä¸å®¹æ˜“ï¼Œç“œå“¥ä»Šå¤©çš„å‘æŒ¥å¤ªé‡è¦äº†ï¼Œå…¨åœº29åˆ†è¿›äº†7ä¸ªä¸‰åˆ†ï¼ŒåŠ æ—¶èµ›è¿™ä¸ªä¸‰åˆ†ä¹Ÿéžå¸¸é‡è¦ï¼Œè¿™èµ›å­£è¦èµ¢çƒå±…ç„¶çœŸçš„å¾—é ç“œå“¥çš„å‘æŒ¥â€¦â€¦ â€‹â€‹â€‹â€‹`,
	`æ”¹ç‰ˆæ— æ•°æ¬¡çš„ç¾Žæ²«æ²¹è†ä¸Šæž¶å’¯ï¼ï¼OæŠ½å¥–è¯¦æƒ…
â„ï¸æ²¹æ•·æ³•å¤ªé€‚åˆè¿™ä¸ªå­£èŠ‚äº†
è¿™æ¬¾æ²¹è†å®ƒèƒ½çœŸæ­£çš„åšåˆ°æ²¹è‚¤
ä½†ä¸ä¼šå¼„åˆ°æ»¡è„¸æ˜¯æ²¹ ç³Šä¹Ÿæ ¹æœ¬ä¸å­˜åœ¨âŒ
âœ”ï¸ç–é€šæ¯›å­” å¹³è¡¡æ²¹è„‚åˆ†æ³Œ
âœ”ï¸æäº®åŽ»é»„è¶…çº§æ˜Žæ˜¾ ðŸ§ðŸ»â€â™€ï¸å°è„¸éƒ½å«©çˆ†äº†
å¦‚æžœæ—©ä¸Šèµ·æ¥æ»¡è„¸æ²¹å…‰çš„åª³å¦‡æ›´åŠ è¦è¯•è¯•ðŸ™‹ðŸ»â€â™€ï¸ç¬¬äºŒå¤©è‚‰çœ¼å¯è§ ä½ ä¸€å®šä¼šæ¥æ„Ÿè°¢æˆ‘ðŸ™
ä¸€ç“¶å¤šç”¨å¯å½“é¢è†œã€é¢éœœã€æŒ‰æ‘©è†çš„æ€§ä»·æ¯”ä¹‹çŽ‹`,
	`æˆ‘åœ¨æƒ³ä¸€ä¸ªå¤§äº‹
æœ‰ç‚¹ä¸è®¡åŽæžœ
ä½†æ˜¯è¿˜æ˜¯è¦å¾æ±‚åŒäº‹ä»¬çš„åŒæ„
ä½ ä»¬ç­‰æˆ‘ä¸€ä¸‹`,
	`XXç‰‡å¥³æ˜Ÿçå¦®æŽæ›¾å±å’¤ç¾Žå›½XXå¸‚åœºï¼Œä»¥äº®ä¸½å¤–åž‹ã€å§£å¥½èº«æé—¯å‡ºä¸€ç‰‡å¤©ï¼Œè¿˜å› æ­¤å°ä¸ºâ€œXXå¥³å¸â€ï¼Œå´åœ¨2009å¹´çªç„¶å®£å¸ƒæ”¾å¼ƒå¥³ä¼˜äº‹ä¸šï¼Œè½¬å¾€æ¨¡ç‰¹å„¿ç•Œå‘å±•ã€‚ä¸è¿‡ï¼Œå¥¹è‡ªæ­¤æ¸æ¸é”€å£°åŒ¿è¿¹ï¼Œæ›¾ä½åœ¨è±ªåŽå…¬å¯“çš„å¥¹ï¼Œè¿‘å¹´è¢«å‘çŽ°æ –èº«äºŽä¸‹æ°´é“ä¸­ã€‚

çå¦®æŽå‡ºèº«ç¾Žå›½ç”°çº³è¥¿å·žï¼Œæœ¬åå²è’‚èŠ¬å¦®â€§è¨å¤šæ‹‰ï¼Œåœ¨XXç½‘ç«™ä¸Šæœ‰è¶…è¿‡ç ´äº¿æµé‡ï¼Œæ›´æœ‰4ä¸‡5000äººè®¢é˜…ã€‚ä½œå“æ— æ•°çš„å¥¹ï¼Œå½“å¹´æœ‰ç€â€œXXå¥³å¸â€çš„åœ°ä½ï¼Œæ›´æœ‰ä¸å°‘æ‚å¿—é‚€çº¦æ‹æ‘„ï¼Œçå¦®æŽä½åœ¨è±ªåŽçš„é¡¶å±‚å…¬å¯“ï¼Œè¿‡ç€æ—¶é«¦åˆå¥¢åŽçš„ç”Ÿæ´»ã€‚ ç„¶è€Œï¼Œçå¦®æŽ12å¹´å‰çªç„¶å®£å¸ƒä»ŽXXç•Œå¼•é€€ï¼Œä»Žæ­¤ä¸å†æ‹ç‰‡ï¼Œå¹¶è½¬åž‹å½“èµ·æ¨¡ç‰¹å„¿ï¼Œä¹‹åŽå´é€æ¸æ¶ˆå£°åŒ¿è¿¹ï¼Œæ¶ˆå¤±åœ¨è§å…‰å¹•å‰ã€‚ç›´åˆ°2019å¹´ï¼Œå¤–åª’æ‰¾åˆ°äº†å¥¹ï¼Œå½“å¹´çš„â€œXXå¥³å¸â€ï¼Œå¦‚ä»Šå´æ˜¯ä½åœ¨ç¾Žå›½æ‹‰æ–¯ç»´åŠ æ–¯çš„ä¸€åº§ä¸‹æ°´é“ã€‚

æ®æŠ¥é“ï¼Œçå¦®æŽçš„â€œæˆ¿é—´â€ä¸­ï¼Œä»…æœ‰ä¸€å¼ åºŠã€ä¸€ä¸ªæŸœå­ã€ä¸€ç›ç¯ï¼Œè¿˜æœ‰ç®€å•å‡ ä»¶è¡£ç‰©ï¼Œå’Œè¿‡åŽ»å±…ä½çš„è±ªå®…å‘ˆçŽ°å¼ºçƒˆå¯¹æ¯”ã€‚å¥¹å½“æ—¶è™½æœªé€éœ²ä½åœ¨åœ°ä¸‹æ°´é“çš„åŽŸå› ï¼Œä½†è¡¨ç¤ºè‡ªå·±è¿‡å¾—å¾ˆå¿«ä¹ï¼Œä½åœ¨åœ°ä¸‹æ°´é“çš„æ—¥å­ï¼Œä¹Ÿæ²¡æœ‰å¤–ç•Œæƒ³åƒå¾—é‚£ä¹ˆç³Ÿï¼Œå’Œé‚»å±…ä»¬ä¹Ÿéƒ½ç›¸å¤„æ„‰å¿«ï¼šâ€œå¤§å®¶ä¹Ÿéƒ½å½¼æ­¤å°Šé‡ï¼Œäººéƒ½éžå¸¸å¥½ï¼Œæˆ‘äº¤åˆ°æ›´å¤šçœŸè¯šçš„æœ‹å‹ã€‚â€ `,
	`#ç¾Žå›½éŸ³ä¹èŠ‚è¸©è¸äº‹ä»¶æ­Œæ‰‹åŠç»„ç»‡æ–¹è¢«èµ·è¯‰# ç»¼åˆå¤šå®¶ç¾Žå›½åª’ä½“æŠ¥é“ï¼Œæˆªè‡³7æ—¥ï¼Œè‡³å°‘ä¸¤åä¼‘æ–¯æ•¦â€œå¤©æ–‡ä¸–ç•Œâ€éŸ³ä¹èŠ‚è¸©è¸äº‹ä»¶å—ä¼¤è€…æèµ·è¯‰è®¼ï¼ŒæŒ‡æŽ§éŸ³ä¹èŠ‚ä¸»åˆ›è€…ã€ç¾Žå›½å½“çº¢è¯´å”±æ­Œæ‰‹ç‰¹æ‹‰ç»´æ–¯Â·æ–¯ç§‘ç‰¹ç­‰äººåŠéŸ³ä¹èŠ‚ç»„ç»‡æ–¹è½»å¿½è§‚ä¼—å®‰å…¨ï¼Œä»¥è‡´é…¿æˆè‡³å°‘8äººæ­»äº¡çš„è¸©è¸æƒ¨å‰§ã€‚#ç¾Žå›½ä¸€éŸ³ä¹èŠ‚è¸©è¸è‡´äººæ­»äº¡æ¼”å‡ºä»ç»§ç»­# ï¼ˆcr.çŽ¯çƒèµ„è®¯ï¼‰`,
}

func TestCreateTable(t *testing.T) {
	// tcp://127.0.0.1:9000?debug=trueï¼Œé‡Œé¢çš„debug=trueï¼Œä¼šæ‰“å°å¦‚ä¸‹çš„è°ƒè¯•ä¿¡æ¯
	//[clickhouse]host(s)=127.0.0.1:9000, database=default, username=default
	//[clickhouse][dial] secure=false, skip_verify=false, strategy=random, ident=1, server=0 -> 127.0.0.1:9000
	//[clickhouse][connect=1][hello] -> Golang SQLDriver 1.1.54213
	//[clickhouse][connect=1][hello] <- ClickHouse 21.10.54449 (UTC)
	//[clickhouse][connect=1]-> ping
	//[clickhouse][connect=1][process] <- pong

	// step 1: connect
	connect, err := sql.Open("clickhouse", "tcp://127.0.0.1:9000?debug=true")
	if err != nil {
		log.Fatal(err)
	}
	if err := connect.Ping(); err != nil {
		if exception, ok := err.(*clickhouse.Exception); ok {
			fmt.Printf("[%d] %s \n%s\n", exception.Code, exception.Message, exception.StackTrace)
		} else {
			fmt.Println(err)
		}
		return
	}

	// step 2: create table
	// todo: éœ€è¦åŠ è‡ªå¢žid
	_, err = connect.Exec(`
		CREATE TABLE IF NOT EXISTS blog(
		    uid UInt64,
		    uname String,
		    mid UInt64,
		    content String,
		    words Array(String),
		    create_day Date,
		    create_time DateTime
		) engine=Memory
	`)

	if err != nil {
		log.Fatal(err)
	}

	use_hmm := true
	x := gojieba.NewJieba()
	defer x.Free()

	// step 3: insert with transaction

	var (
		tx, _   = connect.Begin()
		stmt, _ = tx.Prepare("INSERT INTO blog (uid, uname, mid, content, words, create_day, create_time) VALUES (?, ?, ?, ?, ?, ?, ?)")
	)
	defer stmt.Close()
	iStart := 10000
	cnt := len(blogs)
	iEnd := iStart + cnt
	for i := iStart; i < iEnd; i++ {
		randDate := randDateUpToNow()
		uid := i
		uname := "mengxin_" + strconv.Itoa(i)
		mid := rand.Uint64()
		content := blogs[i%cnt]
		words := x.Cut(content, use_hmm)
		if _, err := stmt.Exec(
			uid,
			uname,
			mid,
			content,
			clickhouse.Array(words),
			//clickhouse.Array([]int16{1, 2, 3}),
			randDate,
			randDate,
		); err != nil {
			log.Fatal(err)
		}
	}

	if err := tx.Commit(); err != nil {
		log.Fatal(err)
	}
}

func TestBlogCount(t *testing.T) {
	fmt.Println(len(blogs))
}
